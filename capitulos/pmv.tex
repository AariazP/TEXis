\ChapterImageStar[cap:pmv]{Producto Mínimo Viable}{./images/fondo.png}\label{cap:pmv}
\mbox{}\\
\section{Código fuente del sistema}
\noindent
El código fuente del sistema, desarrollado en el lenguaje Bash, está disponible en el repositorio de GitHub \href{https://github.com/AariazP/TG-VBC.git}{\texttt{TG-VBC}} en la rama \texttt{scripted-solution}. Este repositorio contiene scripts para la automatización de tareas en la infraestructura de virtualización basada en contenedores, incluyendo la configuración de nodos, despliegue de \VM\ y configuración de Kubernetes. 
La figura~\ref{fig:estructura-proyecto} detalla la estructura del proyecto
\begin{figure}[H]
    \centering
    \includegraphics[scale=0.2]{tablas-images/cp6/src/tree.png}
    \caption{Estructura del proyecto}\label{fig:estructura-proyecto}
\end{figure}

\subsection{Script para obtener la IP de una VM en XCP-ng}
\noindent
El \textit{script} a continuación tiene como propósito obtener la dirección IP asociada a una \VM\ desplegada en un entorno XCP-ng, a partir de su nombre. En primer lugar, valida que el usuario haya proporcionado al menos un argumento, correspondiente al nombre de la \VM, mostrando un mensaje de uso en caso contrario. Posteriormente, contempla una excepción para la máquina denominada \textit{NAT-Master}, devolviendo directamente la IP fija 172.30.29.2. En los demás casos, el script emplea el comando xe para obtener el identificador único (UUID) de la máquina virtual y, a partir de este, extrae las direcciones \MAC\ de sus interfaces de red. Con dichas direcciones, se conecta mediante \SSH\ a la máquina \textit{NAT-Master}, utilizando una clave previamente configurada, y consulta la tabla de vecinos de red (comando ip n) para identificar la IP correspondiente a las \MAC\ recuperadas. Finalmente, devuelve la dirección IP asociada a la \VM\ solicitada. \\

\input{tablas-images/cp6/src/get-ip.tex}


\subsection{Script de configuración de red de las VMs}
\noindent
El \textit{script} a continuación, automatiza la creación y configuración de una red virtual en un entorno XCP-ng, permitiendo la salida a Internet para las máquinas virtuales que se conecten a ella. En primer lugar, define parámetros como el nombre de la red, el rango de direcciones IP (subred), la dirección de la puerta de enlace y la interfaz de salida hacia Internet. Luego, utiliza el comando \texttt{xe network-create} para crear la red virtual sin necesidad de un \textit{bridge} preexistente y obtiene su UUID para validarla. Una vez confirmada la red, se agrega una interfaz virtual al host con una dirección \MAC\ aleatoria. Posteriormente, se asocia al bridge correspondiente la dirección IP de la puerta de enlace definida y se activa la interfaz.
\noindent
\input{tablas-images/cp6/src/red.tex}

\subsection{Script de conexión SSH a una VM}
\noindent
El script a continuación, tiene como propósito facilitar la conexión remota por medio de \SSH\ a las diferentes \VM\ dentro de un entorno administrado, ofreciendo además la posibilidad de ejecutar comandos de forma directa en ellas. Su funcionamiento se puede dividir en las siguientes fases:

\begin{enumerate}
    \item \textbf{Parámetros de entrada}:  
    El script admite dos opciones principales:
    \begin{itemize}
        \item \texttt{-r}: establece que la conexión debe realizarse como el usuario \texttt{root}.
        \item \texttt{-c <comando>}: permite especificar un comando a ejecutar directamente en la máquina virtual, en lugar de iniciar una sesión interactiva.
    \end{itemize}
    Además, es obligatorio proporcionar el nombre de la VM como argumento principal.

    \item \textbf{Procesamiento de opciones}:  
    Se emplea el comando \texttt{getopts} para interpretar los parámetros recibidos. En caso de que los argumentos no cumplan con el formato esperado, se muestra un mensaje de uso correcto y el programa termina.

    \item \textbf{Resolución de la dirección IP de la VM}:  
    A través de la función auxiliar \texttt{get-ip}, el script obtiene la dirección IP asociada a la máquina virtual especificada. Los mensajes de error se redirigen a \texttt{/dev/null} para mantener una salida limpia.

    \item \textbf{Conexión mediante SSH}:  
    Existen dos escenarios:
    \begin{itemize}
        \item Si se activó la opción \texttt{-r}, la conexión se establece como el usuario \texttt{root}, utilizando una clave privada almacenada en \texttt{\~{}/.ssh/id\_internal\_vm}.
        \item En caso contrario, la conexión se realiza con el usuario por defecto, sin especificar clave adicional.
    \end{itemize}
    En ambos casos, si se definió un comando con la opción \texttt{-c}, este será ejecutado de inmediato en la máquina virtual. De lo contrario, se abrirá una sesión \SSH\ interactiva.

\end{enumerate}

\input{tablas-images/cp6/src/ssh-vm.tex}

\subsection{Script de configuración inicial de una VM}
\noindent
El script \texttt{bootup.sh} fue diseñado para desplegar y configurar máquinas virtuales en XCP-ng de forma manual, en un contexto anterior a la creación de plantillas predefinidas. Aunque actualmente no se utiliza de manera habitual, se conserva como alternativa en caso de que las plantillas se pierdan o deba realizarse una instalación manual. A continuación, se detallan sus principales fases de ejecución:

\begin{enumerate}
    \item \textbf{Identificación del entorno}:  
    En primer lugar, el script lista los hosts disponibles mediante \texttt{xe host-list} y obtiene el UUID del host principal, exportándolo como variable de entorno. Posteriormente, muestra los repositorios de almacenamiento (SR) y las plantillas de sistema operativo, filtrando aquellas relacionadas con Debian.

    \item \textbf{Creación de la máquina virtual}:  
    Se define el nombre de la VM (por defecto \texttt{xeclivm} si no se pasa argumento) y se crea una nueva instancia a partir de la plantilla \texttt{Debian Bookworm 12}. A continuación, se obtiene el UUID de la VM recién creada para su uso posterior.

    \item \textbf{Gestión de medios de instalación}:  
    Se prepara un directorio local para almacenar imágenes ISO, se crea un SR de tipo ISO y se obtiene su UUID. Tras forzar un escaneo de dicho repositorio, se selecciona el archivo ISO de instalación de Debian que se utilizará para la instalación de la VM.

    \item \textbf{Configuración de almacenamiento y red}:  
    El script localiza el disco virtual asociado a la VM y lo redimensiona a 20~GiB. Asimismo, identifica el UUID de la red principal (\texttt{xenbr0}) y crea una interfaz de red para la máquina virtual.

    \item \textbf{Parámetros de hardware y arranque}:  
    Se configuran los límites de memoria de la VM (mínimos y máximos) y la política de arranque mediante BIOS. También se desactiva \textit{Secure Boot}, se fuerza el modelo tradicional de QEMU y se definen los dispositivos de arranque (disco y CD).  

    \item \textbf{Gestión de dispositivos de CD-ROM}:  
    Se expulsan posibles medios previos y se insertan las ISOs necesarias, incluyendo tanto \texttt{guest-tools.iso} como la ISO de Debian especificada. Esto asegura que la VM disponga de los medios de instalación y herramientas complementarias.

    \item \textbf{Inicio de la máquina virtual}:  
    Finalmente, la VM se arranca utilizando el UUID generado durante su creación, completando el proceso de despliegue.

\end{enumerate}

\input{tablas-images/cp6/src/bootup-vm.tex}

\subsection{Script para desplegar y arrancar una VM desde plantilla}

El script \texttt{bootvm} está diseñado para automatizar el despliegue y arranque de una \VM\ en un entorno XCP-ng utilizando una plantilla predefinida. Su funcionamiento se describe a continuación:

\begin{enumerate}
    \item \textbf{Validación de argumentos}:  
    El script comprueba que se haya proporcionado al menos un argumento, que corresponde al nombre deseado para la \VM. Si no se especifica ningún argumento, muestra un mensaje de uso correcto (\texttt{usage: bootvm <vm-name>}) y finaliza la ejecución.

    \item \textbf{Instalación de la máquina virtual}:  
    Se utiliza el comando \texttt{xe vm-install} para crear una nueva \VM\ a partir de una plantilla existente, identificada por su UUID (\texttt{0c838875-cb93-dfe3-8c36-a2f42183b434}). El nombre de la nueva \VM\ se asigna según el argumento proporcionado al script. El UUID de la \VM\ recién creada se almacena en la variable \texttt{VM\_UUID} para su uso posterior.

    \item \textbf{Arranque de la VM}:  
    Finalmente, el script inicia la máquina virtual mediante \texttt{xe vm-start}, utilizando el UUID almacenado previamente.

\end{enumerate}

\input{tablas-images/cp6/src/bootvm.tex}
