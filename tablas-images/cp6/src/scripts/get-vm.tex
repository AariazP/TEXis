El siguiente script permite listar las máquinas virtuales disponibles y verificar cuáles se encuentran activas. Para ello, utiliza opciones de línea de comandos que permiten: (i) listar todas las máquinas virtuales, (ii) comprobar mediante \texttt{ping} la disponibilidad de una \VM\ específica, y (iii) limitar el número de resultados mostrados. El script hace uso de los comandos \texttt{xe} para obtener los nombres de las máquinas virtuales y combina utilidades como \texttt{ssh}, \texttt{timeout} y \texttt{grep} para gestionar el filtrado y la verificación de conectividad. 

\begin{minted}[frame=lines,
    fontsize=\scriptsize,
    breaklines]{bash}
#!/bin/bash

CHECK_ALL=0   # Variable que indica si se deben verificar todas las VMs
LIMIT=0       # Límite en el número de VMs a mostrar

# Procesa las opciones de línea de comandos
while getopts "ap:n:" opt; do
  case $opt in
    # -a: activa la verificación de todas las VMs
    a) CHECK_ALL=1 ;;
    # -p <vm_name>: comprueba mediante ping si la VM indicada responde
    p) ssh-vm NAT-Master -c "timeout 3 ping -c 1 $( get-ip $OPTARG )"
       exit $? ;;
    # -n <X>: limita el número de VMs a mostrar
    n) LIMIT=$OPTARG ;;
    # Opción no válida: muestra la ayuda
    *) echo "Usage: $0 [-a] [-p vm_name] [-n X]" >&2
       exit 1 ;;
  esac
done

# Funcionalidad principal:
# Lista las VMs y, si corresponde, verifica cuáles están vivas.
shift $((OPTIND - 1)) # Desplaza los argumentos ya procesados
PATTERN=${1:-""}      # Patrón opcional de búsqueda
[[ $PATTERN == "-a" ]] && PATTERN=${2:-""}

# Obtiene la lista de VMs, excluyendo los dominios de control
VMS=$( xe vm-list | grep name-label | grep -v "Control domain" | grep "${PATTERN}" | cut -d":" -f2 )

if [ $CHECK_ALL -eq 1 ]
then
   COUNT=0
   for vm in $VMS
   do
      # Verifica si la VM responde al ping mediante get-vm
      if timeout 3 get-vm -p "$vm" 1>/dev/null; then
         echo "$vm"
         COUNT=$((COUNT+1))
         # Si se alcanzó el límite, se interrumpe el bucle
         if [ $LIMIT -gt 0 ] && [ $COUNT -ge $LIMIT ]; then
            break
         fi
      fi
   done
else
   # En caso contrario, solo lista las VMs sin comprobar conectividad
   echo "$VMS"
fi
\end{minted}